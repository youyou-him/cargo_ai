{% extends "shipper_base.html" %}
{% block title %}ì‹¤ì‹œê°„ ìš´ì†¡ í˜„í™©{% endblock %}

{% block contents %}
<div id="shipper-tracking-screen" class="content-scrollable">
  <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ë° í˜ì´ì§€ ì œëª© -->
  <div class="flex items-center mb-6">
    <a href="{{ url_for('shipper_my_shipments') }}"
       class="back-btn text-gray-600 hover:text-indigo-600 p-1 mr-2">
      <svg class="w-6 h-6" fill="none" stroke="currentColor"
           viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 19l-7-7 7-7"></path>
      </svg>
    </a>
    <h2 class="text-xl font-bold text-gray-800">ì‹¤ì‹œê°„ ìš´ì†¡ í˜„í™©</h2>
  </div>

  <!-- ì„¤ëª… ë¬¸êµ¬ -->
  <div class="text-center p-8 bg-white rounded-xl shadow-sm mb-6">
    <h3 class="text-lg font-semibold text-gray-800">
      TMAP ì¶œë°œì§€ â€“ ë„ì°©ì§€ ê²½ë¡œì— ê¸°ì‚¬ í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ
    </h3>
  </div>

  <!-- ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ -->
  <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4">
    <div class="flex items-center">
      <div class="flex-shrink-0">
        <span id="connection-status" class="inline-block w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
      </div>
      <div>
        <p class="font-medium">ì‹¤ì‹œê°„ ì¶”ì  ìƒíƒœ: <span id="status-text">ì—°ê²° ì¤‘...</span></p>
        <p class="text-sm">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update">--</span></p>
      </div>
    </div>
  </div>

  <!-- ì§€ë„ í‘œì‹œ ì˜ì—­ -->
  <div id="map" class="w-full h-80 bg-gray-200 rounded-lg mb-6 border-2 border-dashed border-gray-300"></div>

</div>
{% endblock %}

{% block footer %}
<div class="footer-nav flex justify-around">
  <a href="{{ url_for('shipper_dashboard') }}"
     class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
      <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 
               1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 
               0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 
               001.414-1.414l-7-7z"></path>
    </svg>
    <span class="text-xs mt-1">í™ˆ</span>
  </a>
  <a href="{{ url_for('shipper_my_requests') }}"
     class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
      <path d="M3 3h11a1 1 0 011 1v4h2.382a1 1 0 
               01.894.553l1.618 3.236A1 1 0 0119 12v4a1 
               1 0 01-1 1h-1a2 2 0 11-4 0H7a2 2 0 
               11-4 0H2a1 1 0 01-1-1V4a1 1 
               0 011-1zM4 15a1 1 0 102 0 1 1 0 
               00-2 0zm10 0a1 1 0 102 0 1 1 
               0 00-2 0z"></path>
    </svg>
    <span class="text-xs mt-1">ê¸°ì‚¬ ë§¤ì¹­</span>
  </a>
  <a href="{{ url_for('shipper_my_shipments') }}"
     class="flex flex-col items-center text-indigo-600">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 
               2h10a2 2 0 002-2V7a2 2 0 
               00-2-2h-2M9 5a2 2 0 002 
               2h2a2 2 0 002-2M9 5a2 2 
               0 012-2h2a2 2 0 012 
               2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
      </path>
    </svg>
    <span class="text-xs mt-1">ë‚´ ìš´ì†¡</span>
  </a>
  <a href="{{ url_for('shipper_payments') }}"
     class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 10h18M7 15h1m4 0h1m-7 
               4h12a3 3 0 003-3V8a3 3 
               0 00-3-3H6a3 3 0 00-3 
               3v8a3 3 0 003 3z"></path>
    </svg>
    <span class="text-xs mt-1">ê²°ì œ</span>
  </a>
  <a href="{{ url_for('shipper_my_page') }}"
     class="flex flex-col items-center text-gray-500 hover:text-indigo-600">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M16 7a4 4 0 11-8 
               0 4 4 0 018 0zM12 14a7 7 
               0 00-7 7h14a7 7 0 00-7-7z">
      </path>
    </svg>
    <span class="text-xs mt-1">ë§ˆì´í˜ì´ì§€</span>
  </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=685e7ddf6b71b33bbeff08111988694f&libraries=services"></script>

<script>
// ì „ì—­ ë³€ìˆ˜ë“¤
let map = null;
let marker = null;
let evtSource = null;
let isDebugMode = true;
let updateCount = 0;
let lastPosition = null;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;

// ë””ë²„ê·¸ ì •ë³´ ê´€ë¦¬
function updateDebugInfo(message, type = 'info') {
    if (!isDebugMode) return;
    
    const debugContent = document.getElementById('debug-content');
    if (!debugContent) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const colorClass = type === 'error' ? 'text-red-600' : 
                      type === 'success' ? 'text-green-600' : 
                      type === 'warning' ? 'text-yellow-600' : 'text-blue-600';
    
    const newMessage = document.createElement('div');
    newMessage.className = colorClass;
    newMessage.innerHTML = `[${timestamp}] ${message}`;
    
    debugContent.insertBefore(newMessage, debugContent.firstChild);
    
    // ìµœê·¼ 20ê°œ ë©”ì‹œì§€ë§Œ ìœ ì§€
    while (debugContent.children.length > 20) {
        debugContent.removeChild(debugContent.lastChild);
    }
    
    // ìŠ¤í¬ë¡¤ì„ ìµœìƒë‹¨ìœ¼ë¡œ
    debugContent.scrollTop = 0;
}

function clearDebugInfo() {
    const debugContent = document.getElementById('debug-content');
    if (debugContent) {
        debugContent.innerHTML = '';
    }
}

function toggleDebug() {
    isDebugMode = !isDebugMode;
    const debugDiv = document.getElementById('debug-info');
    if (debugDiv) {
        debugDiv.style.display = isDebugMode ? 'block' : 'none';
    }
    updateDebugInfo(`ë””ë²„ê·¸ ëª¨ë“œ ${isDebugMode ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
}

// ìƒíƒœ ì—…ë°ì´íŠ¸
function updateConnectionStatus(status, message) {
    const statusEl = document.getElementById('connection-status');
    const textEl = document.getElementById('status-text');
    const updateEl = document.getElementById('last-update');
    
    if (statusEl) {
        statusEl.className = `inline-block w-3 h-3 rounded-full mr-2 ${
            status === 'connected' ? 'bg-green-500 animate-pulse' :
            status === 'error' ? 'bg-red-500' : 'bg-yellow-500'
        }`;
    }
    
    if (textEl) textEl.textContent = message;
    if (updateEl) updateEl.textContent = new Date().toLocaleTimeString();
}

// ì§€ë„ ì´ˆê¸°í™”
function initializeMap() {
    try {
        updateDebugInfo('ì§€ë„ ì´ˆê¸°í™” ì‹œì‘...', 'info');
        
        // Kakao Maps SDK í™•ì¸
        if (!window.kakao || !window.kakao.maps) {
            throw new Error('Kakao Maps SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        // ì§€ë„ ì»¨í…Œì´ë„ˆ í™•ì¸
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            throw new Error('ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        // ì§€ë„ ìƒì„±
        const mapOptions = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­
            level: 6
        };

        map = new kakao.maps.Map(mapContainer, mapOptions);
        updateDebugInfo('âœ… ì§€ë„ ìƒì„± ì™„ë£Œ', 'success');

        // ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
        const markerImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
        const markerImageSize = new kakao.maps.Size(32, 32);
        const markerImageOptions = { offset: new kakao.maps.Point(16, 32) };
        const markerImage = new kakao.maps.MarkerImage(markerImageSrc, markerImageSize, markerImageOptions);

        // ë§ˆì»¤ ìƒì„±
        marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(37.5665, 126.9780),
            image: markerImage
        });

        updateDebugInfo('âœ… ë§ˆì»¤ ìƒì„± ì™„ë£Œ', 'success');

        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
        kakao.maps.event.addListener(marker, 'click', function() {
            const pos = marker.getPosition();
            updateDebugInfo(`ë§ˆì»¤ í´ë¦­: ${pos.getLat().toFixed(6)}, ${pos.getLng().toFixed(6)}`, 'info');
        });

        return true;
    } catch (error) {
        console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        updateDebugInfo(`âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
        return false;
    }
}

// ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ê°œì„ ëœ ë²„ì „)
function updateMarkerPosition(lat, lng, smoothMove = true) {
    try {
        if (!map || !marker) {
            throw new Error('ì§€ë„ ë˜ëŠ” ë§ˆì»¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
        }

        // ì¢Œí‘œ ìœ íš¨ì„± ê²€ì¦
        if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
            throw new Error(`ìœ íš¨í•˜ì§€ ì•Šì€ ì¢Œí‘œ: lat=${lat}, lng=${lng}`);
        }

        const newPosition = new kakao.maps.LatLng(lat, lng);
        
        // ìœ„ì¹˜ ë³€í™” í™•ì¸
        if (lastPosition) {
            const distance = calculateDistance(
                lastPosition.lat, lastPosition.lng,
                lat, lng
            );

            // ë„ˆë¬´ ì‘ì€ ë³€í™”ëŠ” ë¬´ì‹œ (ë…¸ì´ì¦ˆ ì œê±°)
            if (distance < 0.00001) { // ì•½ 1ë¯¸í„°
                updateDebugInfo(`ìœ„ì¹˜ ë³€í™” ë¯¸ë¯¸ (${(distance * 1000).toFixed(2)}m), ìŠ¤í‚µ`, 'warning');
                return true;
            }
            
            updateDebugInfo(`ìœ„ì¹˜ ë³€í™”: ${(distance * 1000).toFixed(1)}m`, 'info');
        }

        // ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        marker.setPosition(newPosition);
        
        // ì§€ë„ ì¤‘ì‹¬ ì´ë™
        if (smoothMove) {
            map.panTo(newPosition);
        } else {
            map.setCenter(newPosition);
        }

        // ì ì ˆí•œ ì¤Œ ë ˆë²¨ ìœ ì§€
        const currentLevel = map.getLevel();
        if (currentLevel > 8) {
            map.setLevel(6);
        }

        // ìœ„ì¹˜ ì •ë³´ ì €ì¥
        lastPosition = { lat, lng, timestamp: Date.now() };
        updateCount++;

        updateDebugInfo(
            `âœ… ë§ˆì»¤ ì—…ë°ì´íŠ¸ #${updateCount}: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 
            'success'
        );

        updateConnectionStatus('connected', 'ì‹¤ì‹œê°„ ì¶”ì  ì¤‘');
        return true;
        
    } catch (error) {
        console.error('ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        updateDebugInfo(`âŒ ë§ˆì»¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${error.message}`, 'error');
        return false;
    }
}

// ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (ë‘ ì¢Œí‘œê°„ ê±°ë¦¬)
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // km ë‹¨ìœ„
}

// SSE ì—°ê²° í•´ì œ
function closeSSE() {
    if (evtSource) {
        evtSource.close();
        evtSource = null;
        updateDebugInfo('ğŸ”Œ SSE ì—°ê²° ì¢…ë£Œ', 'warning');
    }
}

// SSE ì¬ì—°ê²°
function reconnectSSE() {
    if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
        updateDebugInfo(`âŒ ìµœëŒ€ ì¬ì—°ê²° íšŸìˆ˜(${MAX_RECONNECT_ATTEMPTS}) ì´ˆê³¼`, 'error');
        updateConnectionStatus('error', 'ì—°ê²° ì‹¤íŒ¨');
        return;
    }
    
    reconnectAttempts++;
    updateDebugInfo(`ğŸ”„ SSE ì¬ì—°ê²° ì‹œë„ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}...`, 'warning');
    
    setTimeout(() => {
        initializeSSE();
    }, 2000 * reconnectAttempts); // ì ì§„ì  ì§€ì—°
}

// SSE ì—°ê²° ì´ˆê¸°í™” (ê°œì„ ëœ ë²„ì „)
function initializeSSE() {
    try {
        closeSSE(); // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
        
        const matchId = "{{ match_id }}";
        const sseUrl = "{{ url_for('stream') }}";
        
        updateDebugInfo(`SSE ì—°ê²° ì‹œì‘ - URL: ${sseUrl}, ë§¤ì¹˜ ID: ${matchId}`, 'info');

        evtSource = new EventSource(sseUrl);

        evtSource.onopen = function(event) {
            console.log('ğŸ”— SSE ì—°ê²° ì„±ê³µ');
            updateDebugInfo('ğŸ”— SSE ì—°ê²° ì„±ê³µ', 'success');
            updateConnectionStatus('connected', 'ì‹¤ì‹œê°„ ì—°ê²° í™œì„±');
            reconnectAttempts = 0; // ì„±ê³µì‹œ ì¬ì‹œë„ íšŸìˆ˜ ë¦¬ì…‹
        };

        evtSource.onmessage = function(event) {
            try {
                updateDebugInfo(`ğŸ“¨ ì›ë³¸ ë©”ì‹œì§€: ${event.data}`, 'info');
                
                // ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                if (!event.data || event.data.trim() === '') {
                    updateDebugInfo('âš ï¸ ë¹ˆ ë©”ì‹œì§€ ìˆ˜ì‹ ', 'warning');
                    return;
                }
                
                // JSON íŒŒì‹±
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (parseError) {
                    updateDebugInfo(`âŒ JSON íŒŒì‹± ì‹¤íŒ¨: ${parseError.message}`, 'error');
                    return;
                }
                
                updateDebugInfo(`ğŸ“ íŒŒì‹±ëœ ë°ì´í„°: ${JSON.stringify(data)}`, 'info');

                // ë°ì´í„° êµ¬ì¡° í™•ì¸ - ë‹¤ì–‘í•œ í˜•íƒœ ëŒ€ì‘
                let lat, lng;
                
                if (data.lat && data.lng) {
                    // ì§ì ‘ì ì¸ lat, lng í•„ë“œ
                    lat = data.lat;
                    lng = data.lng;
                } else if (data.latitude && data.longitude) {
                    // latitude, longitude í•„ë“œ
                    lat = data.latitude;
                    lng = data.longitude;
                } else if (data.location) {
                    // location ê°ì²´ ì•ˆì— ì¢Œí‘œ
                    lat = data.location.lat || data.location.latitude;
                    lng = data.location.lng || data.location.longitude;
                } else if (data.coordinates) {
                    // coordinates ë°°ì—´ [lng, lat] (GeoJSON ìŠ¤íƒ€ì¼)
                    if (Array.isArray(data.coordinates) && data.coordinates.length >= 2) {
                        lng = data.coordinates[0];
                        lat = data.coordinates[1];
                    }
                } else {
                    updateDebugInfo('âš ï¸ ì¢Œí‘œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'warning');
                    updateDebugInfo(`ë°ì´í„° í‚¤ë“¤: ${Object.keys(data).join(', ')}`, 'info');
                    return;
                }

                // ì¢Œí‘œ ë³€í™˜ ë° ê²€ì¦
                lat = parseFloat(lat);
                lng = parseFloat(lng);

                if (isNaN(lat) || isNaN(lng)) {
                    updateDebugInfo(`âŒ ì¢Œí‘œ íŒŒì‹± ì‹¤íŒ¨: lat=${lat}, lng=${lng}`, 'error');
                    return;
                }

                // ê·¹ë‹¨ì ì¸ ì¢Œí‘œê°’ í•„í„°ë§
                if (lat === 0 && lng === 0) {
                    updateDebugInfo('âš ï¸ (0, 0) ì¢Œí‘œ ìˆ˜ì‹  - GPS ì˜¤ë¥˜ ê°€ëŠ¥ì„±', 'warning');
                    return;
                }

                // í•œêµ­ ê·¼ì²˜ ì¢Œí‘œ ë²”ìœ„ í™•ì¸ (ê²½ê³ ë§Œ, ì°¨ë‹¨í•˜ì§€ ì•ŠìŒ)
                if (lat < 32 || lat > 44 || lng < 123 || lng > 133) {
                    updateDebugInfo(`âš ï¸ í•œêµ­ ì¢Œí‘œ ë²”ìœ„ ë²—ì–´ë‚¨: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'warning');
                }

                // ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤í–‰
                const success = updateMarkerPosition(lat, lng, true);
                
                if (success) {
                }

            } catch (error) {
                console.error('âŒ SSE ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                updateDebugInfo(`âŒ ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        evtSource.onerror = function(event) {
            console.error('ğŸ”¥ SSE ì—°ê²° ì˜¤ë¥˜:', event);
            updateDebugInfo(`ğŸ”¥ SSE ì—°ê²° ì˜¤ë¥˜: ${event.type}`, 'error');
            updateConnectionStatus('error', 'ì—°ê²° ì˜¤ë¥˜');
            
            closeSSE();
            
            // ì¬ì—°ê²° ì‹œë„
            setTimeout(() => {
                reconnectSSE();
            }, 1000);
        };

    } catch (error) {
        console.error('SSE ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        updateDebugInfo(`âŒ SSE ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
        updateConnectionStatus('error', 'SSE ì´ˆê¸°í™” ì‹¤íŒ¨');
    }
}

// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
function testRandomLocation() {
    // ì„œìš¸ ê·¼ì²˜ ëœë¤ ì¢Œí‘œ ìƒì„±
    const lat = 37.5665 + (Math.random() - 0.5) * 0.1; // Â±0.05ë„
    const lng = 126.9780 + (Math.random() - 0.5) * 0.1;
    
    updateDebugInfo(`ğŸ§ª ëœë¤ ìœ„ì¹˜ í…ŒìŠ¤íŠ¸: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'info');
    updateMarkerPosition(lat, lng, true);
}

function resetToCenter() {
    updateDebugInfo('ğŸ  ì„œìš¸ ì‹œì²­ìœ¼ë¡œ ë¦¬ì…‹', 'info');
    updateMarkerPosition(37.5665, 126.9780, true);
    if (map) map.setLevel(6);
}

// SSE ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
function testSSEMessage() {
    const testData = {
        lat: 37.5665 + (Math.random() - 0.5) * 0.01,
        lng: 126.9780 + (Math.random() - 0.5) * 0.01,
        timestamp: new Date().toISOString()
    };
    
    updateDebugInfo(`ğŸ§ª ê°€ìƒ SSE ë©”ì‹œì§€ í…ŒìŠ¤íŠ¸: ${JSON.stringify(testData)}`, 'info');
    
    // ì‹¤ì œ SSE ë©”ì‹œì§€ ì²˜ë¦¬ ê³¼ì •ì„ ì‹œë®¬ë ˆì´ì…˜
    const fakeEvent = {
        data: JSON.stringify(testData)
    };
    
    if (evtSource && evtSource.onmessage) {
        evtSource.onmessage(fakeEvent);
    } else {
        updateMarkerPosition(testData.lat, testData.lng, true);
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    updateDebugInfo('ğŸ“± í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘', 'info');
    
    // 1. ì§€ë„ ì´ˆê¸°í™”
    setTimeout(() => {
        if (initializeMap()) {
            updateDebugInfo('âœ… ì§€ë„ ì´ˆê¸°í™” ì„±ê³µ', 'success');
            
            // 2. SSE ì—°ê²° ì´ˆê¸°í™” (ì§€ë„ ì´ˆê¸°í™” í›„)
            setTimeout(() => {
                initializeSSE();
            }, 1000);
            
            // 3. ì´ˆê¸° í…ŒìŠ¤íŠ¸ ë§ˆì»¤ (SSE ì—°ê²° í›„)
            setTimeout(() => {
                updateDebugInfo('ğŸš€ ì´ˆê¸° í…ŒìŠ¤íŠ¸ ì‹¤í–‰', 'info');
                testRandomLocation();
            }, 3000);
            
        } else {
            updateConnectionStatus('error', 'ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨');
        }
    }, 500);
});

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
window.addEventListener('beforeunload', function() {
    closeSSE();
});

// ê°œë°œì ë„êµ¬ìš© ì „ì—­ í•¨ìˆ˜ë“¤
window.testMarker = function(lat, lng) {
    lat = lat || (37.5665 + (Math.random() - 0.5) * 0.1);
    lng = lng || (126.9780 + (Math.random() - 0.5) * 0.1);
    updateDebugInfo(`ğŸ§ª ìˆ˜ë™ í…ŒìŠ¤íŠ¸: ${lat}, ${lng}`, 'info');
    return updateMarkerPosition(lat, lng, true);
};

window.getMapInfo = function() {
    if (map && marker) {
        const center = map.getCenter();
        const markerPos = marker.getPosition();
        const level = map.getLevel();
        
        const info = {
            center: { lat: center.getLat(), lng: center.getLng() },
            marker: { lat: markerPos.getLat(), lng: markerPos.getLng() },
            level: level,
            updateCount: updateCount,
            lastPosition: lastPosition,
            sseConnected: evtSource && evtSource.readyState === EventSource.OPEN
        };
        
        console.log('=== ì§€ë„ ì •ë³´ ===');
        console.table(info);
        return info;
    }
    return null;
};

window.forceReconnectSSE = function() {
    updateDebugInfo('ğŸ”„ ê°•ì œ SSE ì¬ì—°ê²°', 'warning');
    closeSSE();
    reconnectAttempts = 0;
    setTimeout(initializeSSE, 1000);
};

</script>
{% endblock %}